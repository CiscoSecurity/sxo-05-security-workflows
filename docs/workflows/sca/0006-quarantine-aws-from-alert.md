---
layout: page
title: Quarantine AWS Instances from Alerts
permalink: /workflows/sca/0006-quarantine-aws-from-alert
parent: Secure Cloud Analytics
grand_parent: Workflows
---

# Quarantine AWS Instances from Alerts
<div markdown="1">
Workflow #0006
{: .label }
</div>

This workflow fetches `Geographically Unusual Remote Access` alerts from the Secure Cloud Analytics (SCA) API for the past hour. Then, for each of those alerts, it attempts to locate a matching AWS instance and restrict SSH access to its security group. Notifications are sent using Webex Teams and an approval is requested to lift the quarantine restrictions.

**Note:** To automate handling of the approval tasks generated by this workflow, be sure to also import [this workflow]({{ site.baseurl }}/workflows/sca/0007-handle-aws-ssh-quarantine-approvals)!

[Workflow Folder]({{ site.github.repository_url }}/tree/Main/Workflows/0006-SCA-QuarantineAWSInstancesFromAlerts__definition_workflow_01KB7F57QJWPF4vcfJy8tJXanOHelboFJVl/){: .btn .btn-blue .mr-2 } [JSON]({{ site.github.repository_url }}/tree/Main/Workflows/0006-SCA-QuarantineAWSInstancesFromAlerts__definition_workflow_01KB7F57QJWPF4vcfJy8tJXanOHelboFJVl/definition_workflow_01KB7F57QJWPF4vcfJy8tJXanOHelboFJVl.json){: .btn .btn-blue }

---

## Requirements
* A Secure Cloud Analytics instance
* An Amazon Web Services account with instances monitored by SCA
* (Optional) Webex Teams

---

## Workflow Steps
1. (Optional) Add global variables to local variables
1. Calculate the start/end times for a 1 hour period of time
1. Fetch `Geographically Unusual Remote Access` alerts from SCA for that time frame
1. Convert the alerts to a table
1. If a Teams room name was provided, translate it into a room ID
1. For each alert in the table:
	* Check if the instance was already quarantined (if so, skip it)
	* Get information about the instance from AWS and extract its security group
	* Revoke SSH access to the group and add an exception for the CIDR network in the local variable
	* Create an approval request to remove the instance from quarantine
	* Send a Webex Teams notification

---

## Configuration
* Make sure `Default TargetGroup` includes the `AWS Endpoint` target type ([more info]({{ site.baseurl }}/workflows/target-groups))
* Set your AWS region in the `AWS Region` local variable
* Add the CIDR network you want to exclude from SSH restrictions in the `CIDR IP to Exclude` local variable (so you can still get into the instance to fix it)
* Add your SCA API key to the `Secure Cloud Analytics API Key` local variable (or, if you have an API key in a global variable already, set the local variable to the global's value using the `Fetch Global Variables` group at the beginning of the workflow)
* The `Approval request to undo AWS SSH quarantine` activity needs to be configured with a task requestor, owner, and assignees (the assignees will be able to approve or deny)
* **Important:** Do not change the `Subject Line` of the approval task or the approval event trigger will stop working

### Using Webex?
* Make sure your bot is added to the room you want to post messages to
* Add your Webex Bot Token to the `Webex Bot Token` local variable (or, if you have a token in a global variable already, set the local variable to the global's value using the `Fetch Global Variables` group at the beginning of the workflow)
* Provide either a `Webex Teams Room Name` or `Webex Teams Room ID` in their respective local variable (only one of the two is required)

### Not Using Webex?
* Check the `Skip Activity Execution` box for all of the Webex activities

---

## Targets
Target Group: `Default TargetGroup`

| Target Name | Type | Details | Account Keys | Notes |
|:------------|:-----|:--------|:-------------|:------|
| Amazon Web Services | AWS Endpoint | _Region:_ `Your Region`<br /> | Your AWS Account Key (see below) | |
| Secure Cloud Analytics | HTTP Endpoint | _Protocol:_ `HTTPS`<br />_Host:_ `your-tenant.obsrvbl.com`<br />_Path:_ `api` | None | |
| Webex Teams | HTTP Endpoint | _Protocol:_ `HTTPS`<br />_Host:_ `webexapis.com`<br />_Path:_ None | None | |

---

## Account Keys

| Account Key Name | Type | Details | Notes |
|:-----------------|:-----|:--------|:------|
| Your AWS Account Key | AWS Credentials | _Access Key:_ AWS API Access Key<br />_Secret Key:_ AWS API Secret Key | |
