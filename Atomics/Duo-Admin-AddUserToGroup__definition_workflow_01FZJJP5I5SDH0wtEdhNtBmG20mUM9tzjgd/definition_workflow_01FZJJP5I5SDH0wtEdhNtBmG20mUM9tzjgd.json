{
  "workflow": {
    "unique_name": "definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd",
    "name": "Duo Admin - Add User to Group",
    "title": "Duo Admin - Add User to Group",
    "type": "generic.workflow",
    "base_type": "workflow",
    "variables": [
      {
        "schema_id": "datatype.string",
        "properties": {
          "value": "",
          "scope": "input",
          "name": "Integration Key",
          "type": "datatype.string",
          "description": "Your Duo API integration key. This is obtained from your application information within the Duo admin interface",
          "is_required": true
        },
        "unique_name": "variable_workflow_01FZJJP53IJ6A0TztGT43MOiZex7UQTS79E",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.string",
        "properties": {
          "value": "",
          "scope": "input",
          "name": "User ID",
          "type": "datatype.string",
          "description": "Permanent, unique identifier for the user as generated by Duo upon user creation (e.g. DUYHV6TJBC3O4RITS1WC)",
          "is_required": true
        },
        "unique_name": "variable_workflow_01FZJJP53IEF01Bn0NRLuKKwqakqb2fBmHk",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.integer",
        "properties": {
          "value": 0,
          "scope": "output",
          "name": "Response Code",
          "type": "datatype.integer",
          "is_required": false
        },
        "unique_name": "variable_workflow_01FZJJP53IDAK1vzSVcJAQ80ceYsLBXs1cN",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.string",
        "properties": {
          "value": "",
          "scope": "input",
          "name": "Group ID",
          "type": "datatype.string",
          "description": "ID of the group to add the user to",
          "is_required": true
        },
        "unique_name": "variable_workflow_01FZJOGBWYEVH5TzdOjnacl6NTHL7IwRnUw",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.string",
        "properties": {
          "value": "/admin/v1/users",
          "scope": "local",
          "name": "path",
          "type": "datatype.string",
          "is_required": false
        },
        "unique_name": "variable_workflow_01FZJJP53I5ZY2ual9ejKBJ6Y43Wn70l2dG",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.secure_string",
        "properties": {
          "value": "",
          "scope": "input",
          "name": "Secret Key",
          "type": "datatype.secure_string",
          "description": "Your Duo API secret key. This is obtained from your application information within the Duo admin interface",
          "is_required": true
        },
        "unique_name": "variable_workflow_01FZJJP53I9IW16EDBLwRTBznAfK8QcBJOb",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.string",
        "properties": {
          "value": "",
          "scope": "output",
          "name": "Response Body",
          "type": "datatype.string",
          "is_required": false
        },
        "unique_name": "variable_workflow_01FZJJP53IQ8K6yxAyX0uLsKvlpTeZ7mkoz",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.string",
        "properties": {
          "value": "",
          "scope": "input",
          "name": "Hostname",
          "type": "datatype.string",
          "description": "Your Duo API hostname. This is obtained from your application information within the Duo admin interface",
          "is_required": true
        },
        "unique_name": "variable_workflow_01FZJJP53IMSS0336uhOPRrxOhiRNfaQ9Xx",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.string",
        "properties": {
          "value": "POST",
          "scope": "local",
          "name": "method",
          "type": "datatype.string",
          "is_required": false
        },
        "unique_name": "variable_workflow_01FZJJP53IGSU50AzL7i4Xc3C5aBildJHHe",
        "object_type": "variable_workflow"
      }
    ],
    "properties": {
      "atomic": {
        "atomic_group": "Cisco Duo Security",
        "is_atomic": true
      },
      "delete_workflow_instance": true,
      "description": "Adds a Duo user to a user group.\n\nNote that this action uses the Duo Admin API which is not enabled by default. You may need to contact Duo Support and ask for the admin API to be enabled. You can then create an application with integration and secret keys following the normal process in your Duo admin panel.\n\n[] Generate a list of parameters to POST to Duo\n[] Assemble the request URL\n[] Generate a signed signature for the request\n[] Send the request to Duo\n[] Extract the response values\n[] Set the workflow's output variables\n[] Check if there was an error\n\nAPI information: https://duo.com/docs/adminapi#associate-group-with-user",
      "display_name": "Duo Admin - Add User to Group",
      "runtime_user": {
        "override_target_runtime_user": false,
        "specify_on_workflow_start": false,
        "target_default": true
      },
      "target": {
        "target_type": "web-service.endpoint",
        "specify_on_workflow_start": true
      }
    },
    "object_type": "definition_workflow",
    "actions": [
      {
        "unique_name": "definition_activity_01FZJJQTWKIFK4U0LIKOXYA54xJxvgh9PH1",
        "name": "Execute Python Script",
        "title": "Generate request parameters",
        "type": "python3.script",
        "base_type": "activity",
        "properties": {
          "action_timeout": 180,
          "continue_on_failure": false,
          "description": "Assembles the parameters for the request",
          "display_name": "Generate request parameters",
          "script": "import sys,json\n\ngroupId = sys.argv[1]\n\nd = {}\nd[\"group_id\"] = groupId\n\nj = json.dumps(d)",
          "script_arguments": [
            "$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.input.variable_workflow_01FZJOGBWYEVH5TzdOjnacl6NTHL7IwRnUw$"
          ],
          "script_queries": [
            {
              "script_query": "j",
              "script_query_name": "params",
              "script_query_type": "string"
            }
          ],
          "skip_execution": false
        },
        "object_type": "definition_activity"
      },
      {
        "unique_name": "definition_activity_01FZJQ4Q1X2UQ0l2GvxyasQFEIiUP2SLdq4",
        "name": "Set Variables",
        "title": "Assemble request URL",
        "type": "core.set_multiple_variables",
        "base_type": "activity",
        "properties": {
          "continue_on_failure": false,
          "display_name": "Assemble request URL",
          "skip_execution": false,
          "variables_to_update": [
            {
              "variable_to_update": "$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.local.variable_workflow_01FZJJP53I5ZY2ual9ejKBJ6Y43Wn70l2dG$",
              "variable_value_new": "$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.local.variable_workflow_01FZJJP53I5ZY2ual9ejKBJ6Y43Wn70l2dG$/$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.input.variable_workflow_01FZJJP53IEF01Bn0NRLuKKwqakqb2fBmHk$/groups"
            }
          ]
        },
        "object_type": "definition_activity"
      },
      {
        "unique_name": "definition_activity_01FZJJR03SZJ11ruXuB6SWE2PHMwb8Yq7cu",
        "name": "Execute Python Script",
        "title": "Generate request signature",
        "type": "python3.script",
        "base_type": "activity",
        "properties": {
          "action_timeout": 180,
          "continue_on_failure": false,
          "description": "Generates and signs the signature for this request",
          "display_name": "Generate request signature",
          "script": "import sys, json, base64, email.utils, hmac, hashlib, urllib, codecs\n\n(method,host,path,params,skey,ikey) = sys.argv[1:]\nparams = json.loads(params)\n\n\"\"\"\nReturn HTTP Basic Authentication (\"Authorization\" and \"Date\") headers.\nmethod, host, path: strings from request\nparams: dict of request parameters\nskey: secret key\nikey: integration key\n\"\"\"\n\n# create canonical string\nnow = email.utils.formatdate()\ncanon = [now, method.upper(), host.lower(), path]\nargs = []\nfor key in sorted(params.keys()):\n   val = params[key]\n   if isinstance(val, str):\n      val = val.encode(\"utf-8\")\n      args.append('%s=%s' % (urllib.parse.quote(key, '~'), urllib.parse.quote(val, '~')))\n   if isinstance(val, int):\n      args.append('%s=%i' % (urllib.parse.quote(key, '~'), val))\nparams = '\u0026'.join(args)\ncanon.append(params)\ncanon = '\\n'.join(canon)\n\n# sign canonical string\nsig = hmac.new(codecs.encode(skey,'latin-1'), codecs.encode(canon), hashlib.sha1)\nauth = '%s:%s' % (ikey, sig.hexdigest())\n\nAuthorization = 'Basic %s' % base64.b64encode(codecs.encode(auth)).decode('utf-8')",
          "script_arguments": [
            "$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.local.variable_workflow_01FZJJP53IGSU50AzL7i4Xc3C5aBildJHHe$",
            "$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.input.variable_workflow_01FZJJP53IMSS0336uhOPRrxOhiRNfaQ9Xx$",
            "$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.local.variable_workflow_01FZJJP53I5ZY2ual9ejKBJ6Y43Wn70l2dG$",
            "$activity.definition_activity_01FZJJQTWKIFK4U0LIKOXYA54xJxvgh9PH1.output.script_queries.params$",
            "$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.input.variable_workflow_01FZJJP53I9IW16EDBLwRTBznAfK8QcBJOb$",
            "$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.input.variable_workflow_01FZJJP53IJ6A0TztGT43MOiZex7UQTS79E$"
          ],
          "script_queries": [
            {
              "script_query": "now",
              "script_query_name": "Date",
              "script_query_type": "secure_string"
            },
            {
              "script_query": "Authorization",
              "script_query_name": "Authorization",
              "script_query_type": "secure_string"
            },
            {
              "script_query": "canon",
              "script_query_name": "canon",
              "script_query_type": "secure_string"
            },
            {
              "script_query": "params",
              "script_query_name": "params_enc",
              "script_query_type": "secure_string"
            }
          ],
          "skip_execution": false
        },
        "object_type": "definition_activity"
      },
      {
        "unique_name": "definition_activity_01FZJJR6UU3T22QNIQ3AHme6tNbpFybj05K",
        "name": "HTTP Request",
        "title": "Execute Duo API call",
        "type": "web-service.http_request",
        "base_type": "activity",
        "properties": {
          "action_timeout": 180,
          "allow_auto_redirect": true,
          "body": "$activity.definition_activity_01FZJJR03SZJ11ruXuB6SWE2PHMwb8Yq7cu.output.script_queries.params_enc$",
          "continue_on_error_status_code": true,
          "continue_on_failure": false,
          "custom_headers": [
            {
              "name": "Date",
              "value": "$activity.definition_activity_01FZJJR03SZJ11ruXuB6SWE2PHMwb8Yq7cu.output.script_queries.Date$"
            },
            {
              "name": "Authorization",
              "value": "$activity.definition_activity_01FZJJR03SZJ11ruXuB6SWE2PHMwb8Yq7cu.output.script_queries.Authorization$"
            },
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            },
            {
              "name": "Host",
              "value": "$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.input.variable_workflow_01FZJJP53IMSS0336uhOPRrxOhiRNfaQ9Xx$"
            }
          ],
          "display_name": "Execute Duo API call",
          "method": "$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.local.variable_workflow_01FZJJP53IGSU50AzL7i4Xc3C5aBildJHHe$",
          "relative_url": "$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.local.variable_workflow_01FZJJP53I5ZY2ual9ejKBJ6Y43Wn70l2dG$",
          "runtime_user": {
            "override_target_runtime_user": false,
            "target_default": true
          },
          "skip_execution": false,
          "target": {
            "override_workflow_target": false,
            "override_workflow_target_group_criteria": false,
            "use_workflow_target": true,
            "use_workflow_target_group": false
          }
        },
        "object_type": "definition_activity"
      },
      {
        "unique_name": "definition_activity_01FZJJRLH91VJ4DCd5OwzvdmWzByylXZ0pl",
        "name": "Set Variables",
        "title": "Set output variables",
        "type": "core.set_multiple_variables",
        "base_type": "activity",
        "properties": {
          "continue_on_failure": false,
          "display_name": "Set output variables",
          "skip_execution": false,
          "variables_to_update": [
            {
              "variable_to_update": "$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.output.variable_workflow_01FZJJP53IDAK1vzSVcJAQ80ceYsLBXs1cN$",
              "variable_value_new": "$activity.definition_activity_01FZJJR6UU3T22QNIQ3AHme6tNbpFybj05K.output.status_code$"
            },
            {
              "variable_to_update": "$workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.output.variable_workflow_01FZJJP53IQ8K6yxAyX0uLsKvlpTeZ7mkoz$",
              "variable_value_new": "$activity.definition_activity_01FZJJR6UU3T22QNIQ3AHme6tNbpFybj05K.output.response_body$"
            }
          ]
        },
        "object_type": "definition_activity"
      },
      {
        "unique_name": "definition_activity_01FZJROUY19AH75lNhxhw2LH095aBwKBvBq",
        "name": "Condition Block",
        "title": "Was the request successful?",
        "type": "logic.if_else",
        "base_type": "activity",
        "properties": {
          "continue_on_failure": false,
          "display_name": "Was the request successful?",
          "skip_execution": false
        },
        "object_type": "definition_activity",
        "blocks": [
          {
            "unique_name": "definition_activity_01FZJROZU0O283Gn2geQiBAtDmyYyAGwoei",
            "name": "Condition Branch",
            "title": "User not found",
            "type": "logic.condition_block",
            "base_type": "activity",
            "properties": {
              "condition": {
                "left_operand": "$activity.definition_activity_01FZJJR6UU3T22QNIQ3AHme6tNbpFybj05K.output.status_code$",
                "operator": "eq",
                "right_operand": 404
              },
              "continue_on_failure": false,
              "display_name": "User not found",
              "skip_execution": false
            },
            "object_type": "definition_activity",
            "actions": [
              {
                "unique_name": "definition_activity_01FZJS99IFA9S4mrqpG4fvpLu3aw6Ry9eUb",
                "name": "Completed",
                "title": "User not found",
                "type": "logic.completed",
                "base_type": "activity",
                "properties": {
                  "completion_type": "failed-completed",
                  "continue_on_failure": false,
                  "display_name": "User not found",
                  "result_message": "A user with the user ID $workflow.definition_workflow_01FZJJP5I5SDH0wtEdhNtBmG20mUM9tzjgd.input.variable_workflow_01FZJJP53IEF01Bn0NRLuKKwqakqb2fBmHk$ was not found",
                  "skip_execution": false
                },
                "object_type": "definition_activity"
              }
            ]
          },
          {
            "unique_name": "definition_activity_01FZJSMHN7QMZ1uLtGtjs5Noh44jizcDVul",
            "name": "Condition Branch",
            "title": "Other error",
            "type": "logic.condition_block",
            "base_type": "activity",
            "properties": {
              "condition": {
                "left_operand": "$activity.definition_activity_01FZJJR6UU3T22QNIQ3AHme6tNbpFybj05K.output.status_code$",
                "operator": "ne",
                "right_operand": 200
              },
              "continue_on_failure": false,
              "display_name": "Other error",
              "skip_execution": false
            },
            "object_type": "definition_activity",
            "actions": [
              {
                "unique_name": "definition_activity_01FZJT06PZKIL5zFbG7Ns6Gk9mFdLxFblYB",
                "name": "Completed",
                "title": "Failed",
                "type": "logic.completed",
                "base_type": "activity",
                "properties": {
                  "completion_type": "failed-completed",
                  "continue_on_failure": false,
                  "display_name": "Failed",
                  "result_message": "Duo returned an unexpected error\n\nStatus code: $activity.definition_activity_01FZJJR6UU3T22QNIQ3AHme6tNbpFybj05K.output.status_code$\nResponse: $activity.definition_activity_01FZJJR6UU3T22QNIQ3AHme6tNbpFybj05K.output.response_body$",
                  "skip_execution": false
                },
                "object_type": "definition_activity"
              }
            ]
          }
        ]
      }
    ],
    "categories": [
      "category_1BMfMXSnJMyt5Ihqi7rWJr5N8cf"
    ]
  }
}